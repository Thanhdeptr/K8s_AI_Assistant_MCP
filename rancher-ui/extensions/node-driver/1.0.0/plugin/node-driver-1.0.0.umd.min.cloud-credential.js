(("undefined"!==typeof self?self:this)["webpackChunknode_driver_1_0_0"]=("undefined"!==typeof self?self:this)["webpackChunknode_driver_1_0_0"]||[]).push([[916],{4247:function(e,t,o){"use strict";function s(e,t,o){return(t=a(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function a(e){var t=i(e,"string");return"symbol"==typeof t?t:t+""}function i(e,t){if("object"!=typeof e||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var s=o.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}o.d(t,{P:function(){return n}});class n{constructor(e,t){s(this,"domainName",""),s(this,"endpoint",""),s(this,"projectDomainName",""),s(this,"projectId",""),s(this,"projectName",""),s(this,"username",""),s(this,"password",""),s(this,"token",""),s(this,"region",""),s(this,"catalog",void 0),s(this,"endpoints",void 0),s(this,"userId",""),s(this,"$dispatch",void 0),s(this,"regionsFromCatalog",[]),t.annotations?Object.keys(t.annotations).forEach((e=>{const o=e.split("/");if(2===o.length&&"openstack.cattle.io"===o[0]){const s=o[1];this[s]=t.annotations[e]}})):Object.keys(t).forEach((e=>{this[e]=t[e]})),this.$dispatch=e.dispatch}async getToken(){const e=this.endpoint.replace(/^https?:\/\//,""),t=`/meta/proxy/${e}`,o=`${t}/auth/tokens`,s={auth:{identity:{methods:["password"],password:{user:{name:this.username,domain:{name:this.domainName},password:this.password}}}}};this.projectName&&(s.auth.scope={project:{name:this.projectName,domain:{name:this.projectDomainName}}});const a={Accept:"application/json"};try{const e=await this.$dispatch("management/request",{url:o,headers:a,method:"POST",redirectUnauthorized:!1,data:s},{root:!0});if(502===e._status)return{error:"Could not proxy request - URL may not be in Rancher's allow list"};const t=e._headers["x-subject-token"];return this.token=t,this.userId=e?.token?.user?.id,this.regionsFromCatalog=[],s.auth.scope&&e?.token&&(this.catalog=e.token.catalog,this.endpoints={},this.catalog.forEach((e=>{const t=e.endpoints.find((e=>"public"===e.interface));t&&t.region_id===this.region&&(this.endpoints[e.type]=t.url),t&&"compute"===e.type&&(this.regionsFromCatalog.includes(t.region_id)||this.regionsFromCatalog.push(t.region_id))}))),this.regionsFromCatalog=this.regionsFromCatalog.map((e=>({id:e}))),e}catch(i){return console.error(i),{error:i}}}async getFlavors(e,t){return await this.getOptions(e,"/flavors","flavors",void 0,t)}async getImages(e,t){return await this.getOptions(e,"/images/detail","images",void 0,t)}async getKeyPairs(e,t){return await this.getOptions(e,"/os-keypairs","keypairs",(e=>e.keypair),t)}async getSecurityGroups(e,t){return await this.getOptions(e,"/os-security-groups","security_groups",void 0,t)}async getFloatingIpPools(e,t){return await this.getOptions(e,"/os-floating-ip-pools","floating_ip_pools",void 0,t)}async getNetworkNames(e,t){return await this.getOptions(e,"/os-tenant-networks","networks",(e=>({...e,name:e.label})),t)}async getAvailabilityZones(e,t){return await this.getOptions(e,"/os-availability-zone","availabilityZoneInfo",(e=>({...e,name:e.zoneName})),t)}async getOptions(e,t,o,s,a){e.busy=!0,e.enabled=!0,e.selected="";const i=await this.makeComputeRequest(t);if(i&&i[o]){let t=i[o]||[];if(s&&(t=t.map((e=>s(e)))),e.options=this.convertToOptions(t),e.busy=!1,a){const t=e.options.find((e=>e.value.name===a));t&&(e.selected=t.value)}!e.selected&&e.options.length>0&&(e.selected=e.options[0].value)}else e.options=[],e.selected=null,e.busy=!1,e.enabled=!1}async makeComputeRequest(e){const t=this.endpoints["compute"].replace(/^https?:\/\//,""),o=`/meta/proxy/${t}`,s=`${o}${e}`,a={Accept:"application/json","X-Auth-Token":this.token};try{const e=await this.$dispatch("management/request",{url:s,headers:a,method:"GET",redirectUnauthorized:!1},{root:!0});return e}catch(i){console.error(i)}}async getProjects(){const e=this.endpoint.replace(/^https?:\/\//,""),t=`/meta/proxy/${e}`,o={Accept:"application/json","X-Auth-Token":this.token};try{const e=await this.$dispatch("management/request",{url:`${t}/users/${this.userId}/projects`,headers:o,method:"GET",redirectUnauthorized:!1},{root:!0});return e?.projects}catch(s){return console.error(s),{error:s}}}async getRegions(){const e=this.endpoint.replace(/^https?:\/\//,""),t=`/meta/proxy/${e}`,o={Accept:"application/json","X-Auth-Token":this.token};try{const e=await this.$dispatch("management/request",{url:`${t}/regions`,headers:o,method:"GET",redirectUnauthorized:!1},{root:!0});return e?.regions}catch(s){return console.error(s),{error:s}}}convertToOptions(e){const t=(e||[]).sort(((e,t)=>e.name.localeCompare(t.name)));return t.map((e=>({label:e.name,value:e})))}}},2172:function(e,t,o){"use strict";o.r(t),o.d(t,{default:function(){return O}});var s=o(9274);const a={class:"row"},i={class:"col span-6"},n={class:"col span-6"},r={class:"row"},l={class:"col span-6"},d={class:"col span-6"},c=["disabled"],p=["disabled"],u={key:2,class:"row mt-20"},h={class:"col span-6"},m={key:0,class:"col span-6"};function v(e,t,o,v,y,k){const b=(0,s.resolveComponent)("LabeledInput"),g=(0,s.resolveComponent)("BusyButton"),f=(0,s.resolveComponent)("Banner"),w=(0,s.resolveComponent)("LabeledSelect");return(0,s.openBlock)(),(0,s.createElementBlock)("div",null,[(0,s.createElementVNode)("div",a,[(0,s.createElementVNode)("div",i,[(0,s.createVNode)(b,{value:o.value.decodedData.endpoint,disabled:1!==y.step,"label-key":"driver.openstack.auth.fields.endpoint","placeholder-key":"driver.openstack.auth.placeholders.endpoint",type:"text",mode:o.mode,onInput:t[0]||(t[0]=e=>{o.value.setData("endpoint",e)})},null,8,["value","disabled","mode"])]),(0,s.createElementVNode)("div",n,[(0,s.createVNode)(b,{value:o.value.decodedData.domainName,disabled:1!==y.step,"label-key":"driver.openstack.auth.fields.domainName","placeholder-key":"driver.openstack.auth.placeholders.domainName",type:"text",mode:o.mode,onInput:t[1]||(t[1]=e=>{o.value.setData("domainName",e)})},null,8,["value","disabled","mode"])])]),(0,s.createElementVNode)("div",r,[(0,s.createElementVNode)("div",l,[(0,s.createVNode)(b,{value:o.value.decodedData.username,disabled:1!==y.step,class:"mt-20","label-key":"driver.openstack.auth.fields.username","placeholder-key":"driver.openstack.auth.placeholders.username",type:"text",mode:o.mode,onInput:t[2]||(t[2]=e=>{o.value.setData("username",e)})},null,8,["value","disabled","mode"])]),(0,s.createElementVNode)("div",d,[(0,s.createVNode)(b,{value:o.value.decodedData.password,disabled:1!==y.step,class:"mt-20","label-key":"driver.openstack.auth.fields.password","placeholder-key":"driver.openstack.auth.placeholders.password",type:"password",mode:o.mode,onInput:t[3]||(t[3]=e=>{o.value.setData("password",e)})},null,8,["value","disabled","mode"])])]),(0,s.createVNode)(g,{ref:"connect","label-key":"driver.openstack.auth.actions.authenticate",disabled:1!==y.step||!k.canAuthenticate,class:"mt-20",onClick:k.connect},null,8,["disabled","onClick"]),(0,s.createElementVNode)("button",{class:"btn role-primary mt-20 ml-20",disabled:y.busy||1===y.step,onClick:t[4]||(t[4]=(...e)=>k.clear&&k.clear(...e))},(0,s.toDisplayString)(e.t("driver.openstack.auth.actions.edit")),9,c),y.error?((0,s.openBlock)(),(0,s.createBlock)(f,{key:0,class:"mt-20",color:"error"},{default:(0,s.withCtx)((()=>[(0,s.createTextVNode)((0,s.toDisplayString)(y.error),1)])),_:1})):(0,s.createCommentVNode)("",!0),y.errorAllowHost?((0,s.openBlock)(),(0,s.createBlock)(f,{key:1,color:"error",class:"allow-list-error"},{default:(0,s.withCtx)((()=>[(0,s.createElementVNode)("div",null,(0,s.toDisplayString)(e.t("driver.openstack.auth.errors.notAllowed",{hostname:k.hostname})),1),(0,s.createElementVNode)("button",{disabled:y.allowBusy,class:"btn ml-10 role-primary",onClick:t[5]||(t[5]=(...e)=>k.addHostToAllowList&&k.addHostToAllowList(...e))},(0,s.toDisplayString)(e.t("driver.openstack.auth.actions.addToAllowList")),9,p)])),_:1})):(0,s.createCommentVNode)("",!0),y.projects?((0,s.openBlock)(),(0,s.createElementBlock)("div",u,[(0,s.createElementVNode)("div",h,[(0,s.createVNode)(w,{modelValue:y.project,"onUpdate:modelValue":t[6]||(t[6]=e=>y.project=e),"label-key":"driver.openstack.auth.fields.project",options:k.projectOptions,searchable:!1},null,8,["modelValue","options"])]),y.regions?((0,s.openBlock)(),(0,s.createElementBlock)("div",m,[(0,s.createVNode)(w,{modelValue:y.region,"onUpdate:modelValue":t[7]||(t[7]=e=>y.region=e),"label-key":"driver.openstack.auth.fields.region",options:k.regionOptions,searchable:!1},null,8,["modelValue","options"])])):(0,s.createCommentVNode)("",!0)])):(0,s.createCommentVNode)("",!0)])}var y=o(8023),k=o(3221),b=o(3733);function g(e){const t=g.options,o=t.parser[t.strictMode?"strict":"loose"].exec(e);if(!o)throw new Error(`Cannot parse as uri: ${e}`);const s={};let a=14;while(a--)s[t.key[a]]=o[a]||"";return s.query={},s.queryStr.replace(t.q.parser,((e,o,a)=>(o&&(s[t.q.name][o]=a),""))),s}g.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","queryStr","anchor"],q:{name:"query",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var f=o(4220);const w=e=>((0,s.pushScopeId)("data-v-79592bcc"),e=e(),(0,s.popScopeId)(),e),$=["disabled","tab-index","data-testid"],N={key:0,class:"icon icon-lg icon-spinner icon-spin"},j={key:1,class:"icon-spacer"},D=w((()=>(0,s.createElementVNode)("span",{class:"icon-spacer"},null,-1)));function C(e,t,o,a,i,n){return(0,s.openBlock)(),(0,s.createElementBlock)("button",{ref:"btn",class:"btn role-primary",disabled:o.disabled,"tab-index":o.tabIndex,"data-testid":o.componentTestid+"-async-button",onClick:t[0]||(t[0]=(...e)=>n.clicked&&n.clicked(...e))},[i.busy?((0,s.openBlock)(),(0,s.createElementBlock)("i",N)):((0,s.openBlock)(),(0,s.createElementBlock)("span",j)),(0,s.createElementVNode)("span",null,(0,s.toDisplayString)(n.displayLabel),1),D],8,$)}var _={props:{label:{type:String,default:void 0},labelKey:{type:String,default:void 0},disabled:{type:Boolean,default:!1},tabIndex:{type:Number,default:null},componentTestid:{type:String,default:"busy-button"},manual:{type:Boolean,default:!1}},data(){return{busy:!1}},computed:{displayLabel(){if(this.labelKey){const e=this.$store.getters["i18n/t"];return e(this.labelKey)}return this.label}},methods:{clicked(e){if(e&&(e.stopPropagation(),e.preventDefault()),this.disabled)return;const t=()=>{this.busy=!1};this.$set(this,"busy",!0),this.$emit("click",t)},focus(){this.$refs.btn.focus()}}},V=(o(561),o(7433));const A=(0,V.A)(_,[["render",C],["__scopeId","data-v-79592bcc"]]);var B=A,E=o(4247),I={components:{Banner:y.A,BusyButton:B,LabeledInput:k.o,LabeledSelect:b.A},props:{mode:{type:String,required:!0},value:{type:Object,required:!0}},async fetch(){this.driver=await this.$store.dispatch("rancher/find",{type:"nodedriver",id:"openstack"})},data(){return this.mode!==f.YQ&&(this.value.decodedData.username=this.value.annotations["openstack.cattle.io/username"],this.value.decodedData.domainName=this.value.annotations["openstack.cattle.io/domainName"],this.value.decodedData.endpoint=this.value.annotations["openstack.cattle.io/endpoint"]),{projects:null,regions:null,step:1,busy:!1,project:"",region:"",errorAllowHost:!1,driver:{},allowBusy:!1,error:""}},computed:{projectOptions(){const e=(this.projects||[]).sort(((e,t)=>e.name.localeCompare(t.name)));return e.map((e=>({label:e.name,value:e.id})))},regionOptions(){const e=(this.regions||[]).sort(((e,t)=>e.name.localeCompare(t.name)));return e.map((e=>({label:e.id,value:e.id})))},hostname(){const e=g(this.value.decodedData.endpoint);return e?.host||""},canAuthenticate(){return!!this.value?.decodedData?.endpoint&&!!this.value?.decodedData?.domainName&&!!this.value?.decodedData?.username&&!!this.value?.decodedData?.password}},created(){this.$emit("validationChanged",!1)},methods:{test(){this.value.annotations=this.value.annotations||{},this.value.annotations["openstack.cattle.io/username"]=this.value.decodedData.username,this.value.annotations["openstack.cattle.io/domainName"]=this.value.decodedData.domainName,this.value.annotations["openstack.cattle.io/endpoint"]=this.value.decodedData.endpoint;const e=this.projects.find((e=>e.id===this.project));return e&&(this.value.annotations["openstack.cattle.io/projectName"]=e.name,this.value.annotations["openstack.cattle.io/projectId"]=e.id,this.value.annotations["openstack.cattle.io/projectDomainName"]=e.domain_id),this.region&&(this.value.annotations["openstack.cattle.io/region"]=this.region),!0},clear(){this.$set(this,"step",1),this.$set(this,"projects",null),this.$set(this,"errorAllowHost",!1),this.$emit("validationChanged",!1)},hostInAllowList(){if(!this.driver?.whitelistDomains)return!1;const e=g(this.value.decodedData.endpoint);return!e.host||(this.driver?.whitelistDomains||[]).includes(e.host)},async addHostToAllowList(){this.$set(this,"allowBusy",!0);const e=g(this.value.decodedData.endpoint);this.driver.whitelistDomains=this.driver.whitelistDomains||[],this.hostInAllowList()||this.driver.whitelistDomains.push(e.host);try{await this.driver.save(),this.$refs.connect.$el.click()}catch(t){console.error("Could not update driver",t),this.$set(this,"allowBusy",!1)}},async connect(e){this.$set(this,"error",""),this.$set(this,"errorAllowHost",!1);let t=!1;if(!this.value.decodedData.endpoint)return e(t);const o=new E.P(this.$store,{endpoint:this.value.decodedData.endpoint,domainName:this.value.decodedData.domainName,username:this.value.decodedData.username,password:this.value.decodedData.password});this.$set(this,"allowBusy",!1),this.$set(this,"step",2),this.$set(this,"busy",!0);const s=await o.getToken();if(s.error)console.error(s.error),t=!1,this.$set(this,"step",1),this.$set(this,"projects",null),502!==s.error._status||this.hostInAllowList()?502===s.error._status?this.$set(this,"error",this.t("driver.openstack.auth.errors.badGateway")):401===s.error._status?this.$set(this,"error",this.t("driver.openstack.auth.errors.unauthorized")):this.$set(this,"error",s.error.message||this.t("driver.openstack.auth.errors.other")):this.$set(this,"errorAllowHost",!0);else{const e=await o.getProjects();e.error?this.$set(this,"error",e.error.message):(this.$set(this,"projects",e),t=!0);const s=await o.getRegions();if(s.error){const e=this.projectOptions[0].value,t=this.projects.find((t=>t.id===e));if(t){const e=new E.P(this.$store,{...o,projectName:t.name,projectId:t.id,projectDomainName:t.domain_id});await e.getToken().then((()=>{this.$set(this,"regions",e.regionsFromCatalog)}))}}else this.$set(this,"regions",s),t=!0}this.$set(this,"busy",!1),this.$set(this,"project",this.projectOptions[0]?.value),this.$set(this,"region",this.regionOptions[0]?.value),this.$emit("validationChanged",t),e(t)}}};o(3631);const x=(0,V.A)(I,[["render",v],["__scopeId","data-v-5b86ab48"]]);var O=x},6783:function(e,t,o){"use strict";o.r(t);var s=o(6758),a=o.n(s),i=o(6173),n=o.n(i),r=n()(a());r.push([e.id,".allow-list-error[data-v-5b86ab48]{display:flex}.allow-list-error[data-v-5b86ab48]>:first-child{flex:1}",""]),t["default"]=r},9569:function(e,t,o){"use strict";o.r(t);var s=o(6758),a=o.n(s),i=o(6173),n=o.n(i),r=n()(a());r.push([e.id,".icon-spacer[data-v-79592bcc]{width:24px}",""]),t["default"]=r},3631:function(e,t,o){var s=o(6783);s.__esModule&&(s=s.default),"string"===typeof s&&(s=[[e.id,s,""]]),s.locals&&(e.exports=s.locals);var a=o(4825).A;a("6f1a5784",s,!0,{sourceMap:!1,shadowMode:!1})},561:function(e,t,o){var s=o(9569);s.__esModule&&(s=s.default),"string"===typeof s&&(s=[[e.id,s,""]]),s.locals&&(e.exports=s.locals);var a=o(4825).A;a("47f1fb01",s,!0,{sourceMap:!1,shadowMode:!1})}}]);
//# sourceMappingURL=node-driver-1.0.0.umd.min.cloud-credential.js.map